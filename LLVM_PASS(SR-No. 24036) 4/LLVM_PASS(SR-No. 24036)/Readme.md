# LLVM COMPILER PASSES
Submitted By : AMIT APPANNA TALAWAR.    
SR-NO : 24036.  
The Tool was built out of tree on LLVM version 18.1.3.

Please download and compile from source the required version to test the tool.
The tool file consists of two passes (Currently has only Instrumentation pass, work on Libc Call Graph is not complete).
1. Libc Call Graph Pass
2. DUMMY SYSTEM CALL Instrumentation

# LIBC Call Graph Pass
A small note on the status of this pass, I'm currently having difficulties merging the graphs, in functions which are calling other functions. I'm having difficulties coding the inheritance part. So I have refrained from posting that pass in the teams.

# Dummy System Call Instrumentation

Enter into the Out of Tree Pass Folder (submitted file) and execute the following commands to generate the shared library pass file.

```bash
cd path/to/the/pass/folder
export LLVM_DIR=<installation/dir/of/llvm18> #installation directory of llvm 18
mkdir build
cd build
export CXX=/usr/bin/clang++-18
export CC=/usr/bin/clang-18
cmake -DLT_LLVM_INSTALL_DIR=<installation/dir/of/llvm18> </path/to/pass/folder>
make
```
We also have to generate the lists of LIBC Function calls, The pass folder has a Python Script to extract all the LIBC function calls of a particular version (which can be changed in the file) and also attaches them with a Unique Identifier for Dummy Sys Call.
```python
cd path/to/the/pass/folder
#Run the python file to generate the txt file.
```

## Compiling MBED-TLS

Before we can test this pass, Install MBED-TLS from source (Preferably in a different directory dont clone it into the Pass Folder).
```bash
git clone https://github.com/Mbed-TLS/mbedtls.git
cd mbedtls
git submodule update --init --recursive
mkdir build
cd build
cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_PROGRAMS=ON ..
```
Now that we have the MBEDTLS source code, we can compile the files in the program folder using CLANG to get the .ll files, which are essentially inputs for our PASS. We can use the bash script generate_ll_files.sh which will compile all the .c files and place them into a folder called mbed_ll_files in our current working directory.
```bash
cd path/to/the/pass/folder
#Set the input and output folder directories in generate_ll_files.sh accordingly
chmod +x generate_ll_files.sh
./generate_ll_files.sh
```

You might encounter some errors while compiling some files that is because some .c files are auto-generated by mbed-tls and they lack header files, just ignore those errors.


## Testing
Now that we have all the prerequisites handled, we have only one bash script to run which will handle the opt command along with our pass plugin for dummy sys call instrumentation and write the instrumented .ll files to our parent folder inside a folder called mbedtls_instrumented.

```bash
#Set the input and output folder directories in mbedtls_dummysyscall.sh accordingly
chmod +x mbedtls_dummysyscall.sh
./mbedtls_dummysyscall.sh
```
You can verify the instrumentation by searching for a LIBC function call in one of these output files, you will encounter a inline ASM system call for DUMMYSYSCALL with an integer input i.e. the Unique Identifier we inserted during extracting process of Libc Function Calls.

```bash
call void asm sideeffect "movq $0, %rax; movq $1, %rdi; syscall", "r,r"(i64 100, i64 11169)
```
Note that the syscall number 100 that we are passing is a dummy identifier of the syscall we are injecting. Can also verify the instrumentation by generating the executable and using objdump to see the instructions instrumented.


<!-- export LLVM_DIR=~/llvm18/build #installation directory of llvm 18
mkdir build
cd build

export CXX=/usr/bin/clang++-18
export CC=/usr/bin/clang-18

cmake -DLT_LLVM_INSTALL_DIR=~/llvm18/build ~/Final_Passes
make


$LLVM_DIR/bin/clang -O0 -emit-llvm -S ../input_files/trial_input.c -o trial_input.ll
$LLVM_DIR/bin/opt -load-pass-plugin ./lib/libDummySysCall.so --passes="inject-dummy-sys-call" -S /home/amit-talawar/mbedtls/ll_files/crypt_and_hash.ll -o output.ll

$LLVM_DIR/bin/opt -load-pass-plugin ./lib/libLibraryCallGraph.so --passes="library-call-graph" -S /home/amit-talawar/mbedtls/ll_files/crypt_and_hash.ll -o output.ll

$LLVM_DIR/bin/clang -emit-llvm -c ~/Semester\ 1/Computer\ System\ Security/Project/Final_Passes/input_files/trial_input.c -o trial_input.bc~/Semester\ 1/Computer\ System\ Security/Project/Final_Passes/

$LLVM_DIR/bin/opt -load-pass-plugin ~/Semester\ 1/Computer\ System\ Security/Project/Final_Passes/build/lib/libStaticCallCounter.so -passes="print<static-cc>" -disable-output trial_input.bc -->

